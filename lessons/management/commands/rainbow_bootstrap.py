from django.core.management.base import BaseCommand
from lessons.models import Lesson, Exercise
from django.utils.text import slugify
import random


LESSONS = [
    {
        "title": "üî¶ –£ –ø–æ—à—É–∫–∞—Ö —Ç—ñ–Ω—ñ",
        "emoji": "üî¶",
        "summary": "–í–∏–≤—á–∞—î–º–æ —Å–≤—ñ—Ç–ª–æ —ñ —Ç—ñ–Ω—å",
        "level": "–ª–µ–≥–∫–æ",
        "duration": 20,
        "age_range": "6‚Äì8",
        "materials": "–ª—ñ—Ö—Ç–∞—Ä–∏–∫, –∞—Ä–∫—É—à –ø–∞–ø–µ—Ä—É, —Ä—É—á–∫–∞",
        "steps": "–£–≤—ñ–º–∫–Ω–∏ –ª—ñ—Ö—Ç–∞—Ä–∏–∫; –ù–∞–ø—Ä–∞–≤ –Ω–∞ —Ä—É–∫—É; –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π –∑–∞ —Ç—ñ–Ω–Ω—é",
        "assistant_image": "images/assistant_girl.png",
        "theory": """
üî¶ –©–æ —Ç–∞–∫–µ —Å–≤—ñ—Ç–ª–æ?

–°–≤—ñ—Ç–ª–æ –¥–æ–∑–≤–æ–ª—è—î –Ω–∞–º –±–∞—á–∏—Ç–∏. –í–æ–Ω–æ –ø–æ—à–∏—Ä—é—î—Ç—å—Å—è –ø—Ä—è–º–æ —ñ —Å—Ç–≤–æ—Ä—é—î —Ç—ñ–Ω—ñ, –∫–æ–ª–∏ –Ω–∞—Ç—Ä–∞–ø–ª—è—î –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç.

üåë –¢–µ–º—Ä—è–≤–∞ ‚Äî —Ü–µ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Å–≤—ñ—Ç–ª–∞.

üé≠ –¢—ñ–Ω—å ‚Äî —Ü–µ –æ–±–ª–∞—Å—Ç—å, –∫—É–¥–∏ –Ω–µ –ø–æ—Ç—Ä–∞–ø–ª—è—î —Å–≤—ñ—Ç–ª–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—à–∫–æ–¥—É.

üåà –°–≤—ñ—Ç–ª–æ –º–æ–∂–µ:
- —Ä—É—Ö–∞—Ç–∏—Å—å –ø—Ä—è–º–æ
- —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç—ñ–Ω—ñ
- –≤—ñ–¥–±–∏–≤–∞—Ç–∏—Å—å
- –±—É—Ç–∏ –∫–æ–ª—å–æ—Ä–æ–≤–∏–º
""",
        "exercises": [
            {
                "title": "–ó–Ω–∞–π–¥–∏ —Å–≤–æ—é —Ç—ñ–Ω—å",
                "instructions": "–ü–æ–∫–∞–∂–∏ –ª—ñ—Ö—Ç–∞—Ä–∏–∫–æ–º –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —ñ –ø–æ–¥–∏–≤–∏—Å—å, —è–∫ —É—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ç—ñ–Ω—å.",
            },
            {
                "title": "–ì—Ä–∞ –∑ —Ç—ñ–Ω—è–º–∏",
                "instructions": "–°—Ç–≤–æ—Ä–∏ —Ç—ñ–Ω—å —Ç–≤–∞—Ä–∏–Ω–∏ —Ä—É–∫–∞–º–∏.",
            },
        ]
    },
    {
        "title": "üéß –ü–æ–¥–æ—Ä–æ–∂ –∑–≤—É–∫–æ–º",
        "emoji": "üéß",
        "summary": "–©–æ —Ç–∞–∫–µ –∑–≤—É–∫ —ñ –≤—ñ–±—Ä–∞—Ü—ñ—è?",
        "level": "–ª–µ–≥–∫–æ",
        "duration": 15,
        "age_range": "6‚Äì9",
        "materials": "–≥—É–º–∫–∞, –ª—ñ–Ω—ñ–π–∫–∞, —Å—Ç—ñ–ª",
        "steps": "–ù–∞—Ç—è–≥–Ω–∏ –≥—É–º–∫—É; –£–¥–∞—Ä —ó—ó —ñ —Å–ª—É—Ö–∞–π –∑–≤—É–∫; –ü–æ–∫–ª–∞–¥–∏ –ª—ñ–Ω—ñ–π–∫—É –Ω–∞ —Å—Ç—ñ–ª, –Ω–∞—Ç–∏—Å–Ω–∏ —ñ –≤—ñ–¥–ø—É—Å—Ç–∏",
        "assistant_image": "images/assistant_boy.png",
        "theory": """
üéß –©–æ —Ç–∞–∫–µ –∑–≤—É–∫?

–ó–≤—É–∫ ‚Äî —Ü–µ –∫–æ–ª–∏–≤–∞–Ω–Ω—è (–≤—ñ–±—Ä–∞—Ü—ñ—ó), —è–∫—ñ –ø–æ—à–∏—Ä—é—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø–æ–≤—ñ—Ç—Ä—è –∞–±–æ —ñ–Ω—à—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏. –ù–∞—à—ñ –≤—É—Ö–∞ –≤–ª–æ–≤–ª—é—é—Ç—å —Ü—ñ –≤—ñ–±—Ä–∞—Ü—ñ—ó ‚Äî —ñ –º–∏ —á—É—î–º–æ –∑–≤—É–∫.

üîä –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –∑–≤—É–∫—É:
- –ü–æ—à–∏—Ä—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø–æ–≤—ñ—Ç—Ä—è
- –ú–∞—î –≥—É—á–Ω—ñ—Å—Ç—å —ñ –≤–∏—Å–æ—Ç—É
- –í–∏–Ω–∏–∫–∞—î —á–µ—Ä–µ–∑ –≤—ñ–±—Ä–∞—Ü—ñ—ó
""",
        "exercises": [
            {
                "title": "–í–≥–∞–¥–∞–π –¥–∂–µ—Ä–µ–ª–æ –∑–≤—É–∫—É",
                "instructions": "–ü–æ—Å–ª—É—Ö–∞–π –∑–≤—É–∫ —ñ–∑ –∑–∞–∫—Ä–∏—Ç–∏–º–∏ –æ—á–∏–º–∞ —ñ –∑–¥–æ–≥–∞–¥–∞–π—Å—è, –∑–≤—ñ–¥–∫–∏ –≤—ñ–Ω –ª—É–Ω–∞—î.",
            },
            {
                "title": "–°–ª—É—Ö–∞–π —ñ –≤–≥–∞–¥—É–π",
                "instructions": "–ü—Ä–æ—Å–ª—É—Ö–∞–π –∑–≤—É–∫ —ñ —Å–ø—Ä–æ–±—É–π –Ω–∞–∑–≤–∞—Ç–∏ –π–æ–≥–æ –¥–∂–µ—Ä–µ–ª–æ.",
            },
        ]
    },
    {
        "title": "üß≤ –ú–∞–≥–Ω—ñ—Ç–Ω—ñ –¥–∏–≤–∞",
        "emoji": "üß≤",
        "summary": "–î–æ—Å–ª—ñ–¥–∂—É—î–º–æ, —è–∫ –ø—Ä–∞—Ü—é—é—Ç—å –º–∞–≥–Ω—ñ—Ç–∏",
        "level": "—Å–µ—Ä–µ–¥–Ω—å–æ",
        "duration": 20,
        "age_range": "7‚Äì10",
        "materials": "–º–∞–≥–Ω—ñ—Ç, —Å–∫—Ä—ñ–ø–∫–∏, –ª–æ–∂–∫–∞, –∞—Ä–∫—É—à –ø–∞–ø–µ—Ä—É",
        "steps": "–ü—Ä–æ–≤–µ–¥–∏ –º–∞–≥–Ω—ñ—Ç–æ–º –Ω–∞–¥ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏; –ü–æ–¥–∏–≤–∏—Å—å, —â–æ –ø—Ä–∏—Ç—è–≥—É—î—Ç—å—Å—è; –°–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –ø–∞–ø—ñ—Ä",
        "assistant_image": "images/assistant_boy.png",
        "theory": """
üß≤ –©–æ —Ç–∞–∫–µ –º–∞–≥–Ω—ñ—Ç?

–ú–∞–≥–Ω—ñ—Ç–∏ –ø—Ä–∏—Ç—è–≥—É—é—Ç—å –¥–µ—è–∫—ñ –ø—Ä–µ–¥–º–µ—Ç–∏, –æ—Å–æ–±–ª–∏–≤–æ —Ç—ñ, —â–æ –º—ñ—Å—Ç—è—Ç—å –∑–∞–ª—ñ–∑–æ. –í–æ–Ω–∏ –º–∞—é—Ç—å –¥–≤–∞ –ø–æ–ª—é—Å–∏ ‚Äî –ø—ñ–≤–Ω—ñ—á–Ω–∏–π —ñ –ø—ñ–≤–¥–µ–Ω–Ω–∏–π.

üîç –¶—ñ–∫–∞–≤—ñ —Ñ–∞–∫—Ç–∏:
- –î–µ—è–∫—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ –Ω–µ —Ä–µ–∞–≥—É—é—Ç—å –Ω–∞ –º–∞–≥–Ω—ñ—Ç.
- –ú–∞–≥–Ω—ñ—Ç–∏ –º–æ–∂—É—Ç—å –ø—Ä–∏—Ç—è–≥—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ —Ç–æ–Ω–∫—ñ —Ä–µ—á—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–∞–ø—ñ—Ä).
""",
        "exercises": [
            {
                "title": "–ú–∞–≥–Ω—ñ—Ç–Ω–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤",
                "instructions": "–ó–Ω–∞–π–¥–∏ 5 –ø—Ä–µ–¥–º–µ—Ç—ñ–≤, —è–∫—ñ –ø—Ä–∏—Ç—è–≥—É—î –º–∞–≥–Ω—ñ—Ç.",
            },
            {
                "title": "–ú–∞–≥–Ω—ñ—Ç —á–µ—Ä–µ–∑ –ø–∞–ø—ñ—Ä",
                "instructions": "–°–ø—Ä–æ–±—É–π –ø—Ä–∏—Ç—è–≥–Ω—É—Ç–∏ —Å–∫—Ä—ñ–ø–∫—É —á–µ—Ä–µ–∑ –∞—Ä–∫—É—à –ø–∞–ø–µ—Ä—É.",
            },
        ]
    },
    {
        "title": "üåç –°–∏–ª–∞ —Ç—è–∂—ñ–Ω–Ω—è",
        "emoji": "üåç",
        "summary": "–î—ñ–∑–Ω–∞—î–º–æ—Å—å, —á–æ–º—É –ø—Ä–µ–¥–º–µ—Ç–∏ –ø–∞–¥–∞—é—Ç—å –≤–Ω–∏–∑",
        "level": "–ª–µ–≥–∫–æ",
        "duration": 15,
        "age_range": "6‚Äì8",
        "materials": "–º'—è—á, –ø–µ—Ä–æ, –∞—Ä–∫—É—à –ø–∞–ø–µ—Ä—É",
        "steps": "–ü—ñ–¥–∫–∏–Ω—å –º'—è—á; –ü—ñ–¥–∫–∏–Ω—å –ø–µ—Ä–æ; –ü–æ—Ä—ñ–≤–Ω—è–π, —è–∫ –≤–æ–Ω–∏ –ø–∞–¥–∞—é—Ç—å",
        "assistant_image": "images/assistant_girl.png",
        "theory": """
üåç –©–æ —Ç–∞–∫–µ —Å–∏–ª–∞ —Ç—è–∂—ñ–Ω–Ω—è?

–¶–µ —Å–∏–ª–∞, —è–∫–∞ —Ç—è–≥–Ω–µ –≤—Å–µ –¥–æ –ó–µ–º–ª—ñ. –°–∞–º–µ —á–µ—Ä–µ–∑ –Ω–µ—ó –ø—Ä–µ–¥–º–µ—Ç–∏ –ø–∞–¥–∞—é—Ç—å –≤–Ω–∏–∑.

üß™ –¶—ñ–∫–∞–≤–æ –∑–Ω–∞—Ç–∏:
- –°–∏–ª–∞ —Ç—è–∂—ñ–Ω–Ω—è –¥—ñ—î –Ω–∞ –≤—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏.
- –î–µ—è–∫—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ –ø–∞–¥–∞—é—Ç—å –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ —á–µ—Ä–µ–∑ –æ–ø—ñ—Ä –ø–æ–≤—ñ—Ç—Ä—è.
""",
        "exercises": [
            {
                "title": "–©–æ —à–≤–∏–¥—à–µ –ø–∞–¥–∞—î?",
                "instructions": "–ü–æ—Ä—ñ–≤–Ω—è–π –ø–∞–¥—ñ–Ω–Ω—è –º'—è—á–∞ —ñ –ø–µ—Ä–∞.",
            },
            {
                "title": "–°—Ç—Ä–∏–±–∞–π –≤–∏—Å–æ–∫–æ!",
                "instructions": "–°–ø—Ä–æ–±—É–π —Å—Ç—Ä–∏–±–Ω—É—Ç–∏ —ñ –≤—ñ–¥—á—É—Ç–∏, —è–∫ –∑–µ–º–ª—è —Ç–µ–±–µ –ø—Ä–∏—Ç—è–≥—É—î –Ω–∞–∑–∞–¥.",
            },
        ]
    },
    {
        "title": "üåà –ë–∞—Ä–≤–∏ –≤–µ—Å–µ–ª–∫–∏",
        "emoji": "üåà",
        "summary": "–Ø–∫ —É—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤–µ—Å–µ–ª–∫–∞ —ñ —è–∫—ñ –≤ –Ω–µ—ó –∫–æ–ª—å–æ—Ä–∏",
        "level": "–ª–µ–≥–∫–æ",
        "duration": 15,
        "age_range": "6‚Äì9",
        "materials": "—Å–∫–ª—è–Ω–∫–∞ –≤–æ–¥–∏, –ª—ñ—Ö—Ç–∞—Ä–∏–∫, –¥–∑–µ—Ä–∫–∞–ª—å—Ü–µ",
        "steps": "–ù–∞–ª–∏–π –≤–æ–¥—É –≤ —Å–∫–ª—è–Ω–∫—É; –ü–æ–∫–ª–∞–¥–∏ –¥–∑–µ—Ä–∫–∞–ª—å—Ü–µ; –ü–æ—Å–≤—ñ—Ç–∏ –ª—ñ—Ö—Ç–∞—Ä–∏–∫–æ–º —ñ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π –∫–æ–ª—å–æ—Ä–∏",
        "assistant_image": "images/assistant_girl.png",
        "theory": """
üåà –Ø–∫ –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤–µ—Å–µ–ª–∫–∞?

–í–µ—Å–µ–ª–∫–∞ –≤–∏–Ω–∏–∫–∞—î, –∫–æ–ª–∏ —Å–≤—ñ—Ç–ª–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –∫—Ä–∞–ø–ª—ñ –≤–æ–¥–∏ —ñ —Ä–æ–∑–∫–ª–∞–¥–∞—î—Ç—å—Å—è –Ω–∞ –∫–æ–ª—å–æ—Ä–∏.

üé® –ö–æ–ª—å–æ—Ä–∏ –≤–µ—Å–µ–ª–∫–∏:
- —á–µ—Ä–≤–æ–Ω–∏–π
- –æ—Ä–∞–Ω–∂–µ–≤–∏–π
- –∂–æ–≤—Ç–∏–π
- –∑–µ–ª–µ–Ω–∏–π
- –±–ª–∞–∫–∏—Ç–Ω–∏–π
- —Å–∏–Ω—ñ–π
- —Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π
""",
        "exercises": [
            {
                "title": "–°—Ç–≤–æ—Ä–∏ –≤–µ—Å–µ–ª–∫—É",
                "instructions": "–ó—Ä–æ–±–∏ –≤–µ—Å–µ–ª–∫—É –≤–¥–æ–º–∞ –∑ –≤–æ–¥–æ—é —ñ —Å–≤—ñ—Ç–ª–æ–º.",
            },
            {
                "title": "–ó–∞–ø–∞–º'—è—Ç–∞–π –∫–æ–ª—å–æ—Ä–∏",
                "instructions": "–ü–µ—Ä–µ—Ä–∞—Ö—É–π—Ç–µ —Ä–∞–∑–æ–º —É—Å—ñ 7 –∫–æ–ª—å–æ—Ä—ñ–≤ –≤–µ—Å–µ–ª–∫–∏.",
            },
        ]
    }
]



from django.core.management.base import BaseCommand
from lessons.models import Lesson, Exercise
from django.utils.text import slugify
import random

# üß™ –î–æ–¥–∞–π —Å—é–¥–∏ —Å–≤—ñ–π —Å–ø–∏—Å–æ–∫ LESSONS, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ

def generate_unique_slug(model, base, max_length=50):
    slug = slugify(base)[:max_length]
    original_slug = slug
    counter = 1
    while model.objects.filter(slug=slug).exists():
        suffix = f"-{counter}"
        slug = f"{original_slug[:max_length - len(suffix)]}{suffix}"
        counter += 1
    return slug


class Command(BaseCommand):
    help = "–ó–∞–ø–æ–≤–Ω—é—î –±–∞–∑—É –∫—ñ–ª—å–∫–æ–º–∞ —É—Ä–æ–∫–∞–º–∏ —Ç–∞ –≤–ø—Ä–∞–≤–∞–º–∏"

    def add_arguments(self, parser):
        parser.add_argument('--cleanup', action='store_true', help='–í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫–∏ –∑ –ø–æ—Ä–æ–∂–Ω—ñ–º–∏ –∞–±–æ –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–º–∏ slug')

    def handle(self, *args, **options):
        if options['cleanup']:
            self.cleanup_invalid_lessons()

        created_count = 0
        for data in LESSONS:
            slug = slugify(data["title"], allow_unicode=True).strip()
            if not slug:
                self.stdout.write(self.style.WARNING(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ —É—Ä–æ–∫ –±–µ–∑ slug: {data['title']}"))
                continue

            lesson, created = Lesson.objects.get_or_create(
                slug=slug,
                defaults={
                    "title": data["title"],
                    "emoji": data["emoji"],
                    "summary": data["summary"],
                    "level": data["level"],
                    "duration": data["duration"],
                    "age_range": data["age_range"],
                    "materials": data["materials"],
                    "steps": data["steps"],
                    "assistant_image": data.get("assistant_image", random.choice([
                        "images/assistant_girl.png",
                        "images/assistant_boy.png"
                    ])),
                    "theory": data.get("theory", ""),
                }
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f"‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —É—Ä–æ–∫: {lesson.title}"))
                created_count += 1
            else:
                self.stdout.write(f"‚Ü™Ô∏è –£—Ä–æ–∫ –≤–∂–µ —ñ—Å–Ω—É—î: {lesson.title}")

            for index, ex in enumerate(data["exercises"], start=1):
                Exercise.objects.get_or_create(
                    lesson=lesson,
                    title=ex["title"],
                    defaults={
                        "instructions": ex["instructions"],
                        "slug": generate_unique_slug(Exercise, ex["title"]),
                        "order": index,
                    }
                )
        self.stdout.write(self.style.SUCCESS(f"\n‚ú® –ì–æ—Ç–æ–≤–æ! –î–æ–¥–∞–Ω–æ {created_count} –Ω–æ–≤–∏—Ö —É—Ä–æ–∫—ñ–≤."))

    def cleanup_invalid_lessons(self):
        bad_lessons = Lesson.objects.filter(slug__isnull=True) | Lesson.objects.filter(slug="")
        count = bad_lessons.count()
        bad_lessons.delete()
        self.stdout.write(self.style.WARNING(f"üßπ –í–∏–¥–∞–ª–µ–Ω–æ {count} —É—Ä–æ–∫(—ñ–≤) –∑ –ø–æ—Ä–æ–∂–Ω—ñ–º slug."))
